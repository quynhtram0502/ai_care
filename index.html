 <!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Care - Nh·∫≠n di·ªán c·∫£m x√∫c h·ªçc sinh</title>

  <!-- Th∆∞ vi·ªán TensorFlow.js v√† Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

  <style>
    body {
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
      background: linear-gradient(180deg,#eaf6ff,#ffffff);
      margin: 0;
      padding: 20px;
      text-align: center;
      color: #0b3d66;
    }
    h1 { margin-top: 6px; }
    #controls { margin-top: 14px; }
    button {
      background:#0077cc;color:#fff;border:none;padding:10px 16px;border-radius:8px;
      font-size:16px;cursor:pointer;
    }
    button:active{transform:translateY(1px);}
    #webcam-wrapper{ margin-top:18px; display:inline-block; background:#fff; padding:12px; border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
    }
    video, canvas { border-radius:8px; }
    #label-container { margin-top:14px; font-size:18px; background:#fff;padding:12px;border-radius:10px; display:inline-block; min-width:320px; box-shadow:0 4px 12px rgba(0,0,0,0.06); }
    #status { margin-top:10px; color:#444; font-size:14px; }
    .hint { margin-top:8px; font-size:13px; color:#666; }
  </style>
</head>
<body>
  <h1>AI Care ‚Äî Nh·∫≠n di·ªán c·∫£m x√∫c h·ªçc sinh</h1>
  <div id="controls">
    <button id="startBtn">üé• B·∫≠t camera & b·∫Øt ƒë·∫ßu</button>
    <button id="stopBtn" style="display:none;margin-left:8px;background:#ff6b6b">‚èπ D·ª´ng</button>
  </div>

  <div id="webcam-wrapper" style="display:none;">
    <video id="webcam" width="320" height="320" autoplay playsinline></video>
  </div>

  <div id="label-container">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</div>
  <div id="status" class="hint">L∆∞u √Ω: b·∫°n c·∫ßn c√≥ th∆∞ m·ª•c <strong>model/</strong> (model.json, metadata.json, .bin) ƒë·∫∑t c√πng c·∫•p v·ªõi file n√†y.</div>

  <script>
    // ƒê·∫∂T ƒê√öNG T√äN TH∆Ø M·ª§C MODEL ·ªû ƒê√ÇY:
    const MODEL_URL = "model/"; // n·∫øu b·∫°n ƒë·ªïi t√™n th∆∞ m·ª•c model th√¨ thay string n√†y

    let model, webcam, maxPredictions;
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const webcamEl = document.getElementById("webcam");
    const wrapper = document.getElementById("webcam-wrapper");
    const labelContainer = document.getElementById("label-container");
    const status = document.getElementById("status");

    startBtn.addEventListener("click", initAndStart);
    stopBtn.addEventListener("click", stopCamera);

    async function initAndStart() {
      startBtn.disabled = true;
      status.innerText = "ƒêang n·∫°p m√¥ h√¨nh... vui l√≤ng ch·ªù.";
      try {
        const modelURL = MODEL_URL + "model.json";
        const metadataURL = MODEL_URL + "metadata.json";
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();
      } catch (err) {
        status.innerText = "Kh√¥ng t√¨m th·∫•y m√¥ h√¨nh. H√£y ch·∫Øc th∆∞ m·ª•c 'model' (model.json, metadata.json, .bin) n·∫±m c√πng n∆°i v·ªõi index.html.";
        startBtn.disabled = false;
        return;
      }

      // Kh·ªüi t·∫°o webcam
      try {
        wrapper.style.display = "inline-block";
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        webcamEl.srcObject = stream;
        await new Promise((res) => (webcamEl.onloadedmetadata = res));
      } catch (err) {
        status.innerText = "Kh√¥ng m·ªü ƒë∆∞·ª£c camera. Vui l√≤ng cho ph√©p quy·ªÅn camera ho·∫∑c th·ª≠ tr√¨nh duy·ªát kh√°c.";
        startBtn.disabled = false;
        return;
      }

      stopBtn.style.display = "";
      startBtn.style.display = "none";
      status.innerText = "M√¥ h√¨nh s·∫µn s√†ng. ƒêang ph√¢n t√≠ch...";

      // T·∫°o canvas t·∫°m ƒë·ªÉ g·ª≠i v√†o model
      window._tmCanvas = document.createElement("canvas");
      window._tmCanvas.width = 320;
      window._tmCanvas.height = 320;
      requestAnimationFrame(loop);
    }

    async function loop() {
      // copy frame t·ª´ video v√†o canvas
      const ctx = window._tmCanvas.getContext("2d");
      ctx.drawImage(webcamEl, 0, 0, window._tmCanvas.width, window._tmCanvas.height);

      // D·ª± ƒëo√°n
      try {
        const prediction = await model.predict(window._tmCanvas);
        prediction.sort((a,b) => b.probability - a.probability);
        const top = prediction[0];
        displayResult(top.className, top.probability);
      } catch (err) {
        // n·∫øu c√≥ l·ªói prediction, hi·ªÉn th·ªã
        labelContainer.innerText = "L·ªói khi d·ª± ƒëo√°n: " + (err.message || err);
      }

      // ti·∫øp t·ª•c v√≤ng l·∫∑p n·∫øu camera c√≤n b·∫≠t
      if (stopBtn.style.display !== "none") {
        requestAnimationFrame(loop);
      }
    }

    function displayResult(className, prob) {
      const p = Math.round(prob * 100);
      let text = "";
      if (className === "Vui") text = `üòä ${p}% ‚Äî B·∫°n ƒëang vui, ti·∫øp t·ª•c nh√©!`;
      else if (className === "Bu·ªìn") text = `üòî ${p}% ‚Äî C√≥ v·∫ª b·∫°n bu·ªìn. H√£y chia s·∫ª c√πng ng∆∞·ªùi tin c·∫≠y.`;
      else if (className === "CƒÉng th·∫≥ng") text = `üò£ ${p}% ‚Äî B·∫°n cƒÉng th·∫≥ng. N√™n ngh·ªâ ng∆°i v√†i ph√∫t, h√≠t th·ªü s√¢u.`;
      else if (className === "M·ªát m·ªèi") text = `üò¥ ${p}% ‚Äî C√≥ v·∫ª m·ªát m·ªèi. U·ªëng n∆∞·ªõc v√† th∆∞ gi√£n.`;
      else text = `${className} ‚Äî ${p}%`;

      labelContainer.innerText = text;
    }

    function stopCamera() {
      // d·ª´ng stream video
      const stream = webcamEl.srcObject;
      if (stream) {
        const tracks = stream.getTracks();
        tracks.forEach(track => track.stop());
      }
      webcamEl.srcObject = null;
      stopBtn.style.display = "none";
      startBtn.style.display = "";
      startBtn.disabled = false;
      wrapper.style.display = "none";
      labelContainer.innerText = "ƒê√£ d·ª´ng camera.";
      status.innerText = "B·∫°n c√≥ th·ªÉ b·∫≠t l·∫°i khi c·∫ßn.";
    }
  </script>
</body>
</html>
const URL = "model/";
